import{a as P,V as R,W as U,X as x,r as v,Y as k,L as C,Z as z,$ as D,Q as M,k as L,a0 as $,q as N}from"#entry";function E(t){return typeof t=="string"?`'${t}'`:new B().serialize(t)}const B=(function(){class t{#e=new Map;compare(e,r){const o=typeof e,s=typeof r;return o==="string"&&s==="string"?e.localeCompare(r):o==="number"&&s==="number"?e-r:String.prototype.localeCompare.call(this.serialize(e,!0),this.serialize(r,!0))}serialize(e,r){if(e===null)return"null";switch(typeof e){case"string":return r?e:`'${e}'`;case"bigint":return`${e}n`;case"object":return this.$object(e);case"function":return this.$function(e)}return String(e)}serializeObject(e){const r=Object.prototype.toString.call(e);if(r!=="[object Object]")return this.serializeBuiltInType(r.length<10?`unknown:${r}`:r.slice(8,-1),e);const o=e.constructor,s=o===Object||o===void 0?"":o.name;if(s!==""&&globalThis[s]===o)return this.serializeBuiltInType(s,e);if(typeof e.toJSON=="function"){const i=e.toJSON();return s+(i!==null&&typeof i=="object"?this.$object(i):`(${this.serialize(i)})`)}return this.serializeObjectEntries(s,Object.entries(e))}serializeBuiltInType(e,r){const o=this["$"+e];if(o)return o.call(this,r);if(typeof r?.entries=="function")return this.serializeObjectEntries(e,r.entries());throw new Error(`Cannot serialize ${e}`)}serializeObjectEntries(e,r){const o=Array.from(r).sort((i,u)=>this.compare(i[0],u[0]));let s=`${e}{`;for(let i=0;i<o.length;i++){const[u,l]=o[i];s+=`${this.serialize(u,!0)}:${this.serialize(l)}`,i<o.length-1&&(s+=",")}return s+"}"}$object(e){let r=this.#e.get(e);return r===void 0&&(this.#e.set(e,`#${this.#e.size}`),r=this.serializeObject(e),this.#e.set(e,r)),r}$function(e){const r=Function.prototype.toString.call(e);return r.slice(-15)==="[native code] }"?`${e.name||""}()[native]`:`${e.name}(${e.length})${r.replace(/\s*\n\s*/g,"")}`}$Array(e){let r="[";for(let o=0;o<e.length;o++)r+=this.serialize(e[o]),o<e.length-1&&(r+=",");return r+"]"}$Date(e){try{return`Date(${e.toISOString()})`}catch{return"Date(null)"}}$ArrayBuffer(e){return`ArrayBuffer[${new Uint8Array(e).join(",")}]`}$Set(e){return`Set${this.$Array(Array.from(e).sort((r,o)=>this.compare(r,o)))}`}$Map(e){return this.serializeObjectEntries("Map",e.entries())}}for(const n of["Error","RegExp","URL"])t.prototype["$"+n]=function(e){return`${n}(${e})`};for(const n of["Int8Array","Uint8Array","Uint8ClampedArray","Int16Array","Uint16Array","Int32Array","Uint32Array","Float32Array","Float64Array"])t.prototype["$"+n]=function(e){return`${n}[${e.join(",")}]`};for(const n of["BigInt64Array","BigUint64Array"])t.prototype["$"+n]=function(e){return`${n}[${e.join("n,")}${e.length>0?"n":""}]`};return t})();function _(t,n){return t===n||E(t)===E(n)}const F="$s";function V(...t){const n=typeof t[t.length-1]=="string"?t.pop():void 0;typeof t[0]!="string"&&t.unshift(n);const[e,r]=t;if(!e||typeof e!="string")throw new TypeError("[nuxt] [useState] key must be a string: "+e);if(r!==void 0&&typeof r!="function")throw new Error("[nuxt] [useState] init must be a function: "+r);const o=F+e,s=P(),i=R(s.payload.state,o);if(i.value===void 0&&r){const u=r();if(U(u))return s.payload.state[o]=u,u;i.value=u}return i}function q(t,n){if(typeof t!="string")throw new TypeError("argument str must be a string");const e={},r=n||{},o=r.decode||H;let s=0;for(;s<t.length;){const i=t.indexOf("=",s);if(i===-1)break;let u=t.indexOf(";",s);if(u===-1)u=t.length;else if(u<i){s=t.lastIndexOf(";",i-1)+1;continue}const l=t.slice(s,i).trim();if(r?.filter&&!r?.filter(l)){s=u+1;continue}if(e[l]===void 0){let f=t.slice(i+1,u).trim();f.codePointAt(0)===34&&(f=f.slice(1,-1)),e[l]=J(f,o)}s=u+1}return e}function H(t){return t.includes("%")?decodeURIComponent(t):t}function J(t,n){try{return n(t)}catch{return t}}const w=/^[\u0009\u0020-\u007E\u0080-\u00FF]+$/;function j(t,n,e){const r=e||{},o=r.encode||encodeURIComponent;if(typeof o!="function")throw new TypeError("option encode is invalid");if(!w.test(t))throw new TypeError("argument name is invalid");const s=o(n);if(s&&!w.test(s))throw new TypeError("argument val is invalid");let i=t+"="+s;if(r.maxAge!==void 0&&r.maxAge!==null){const u=r.maxAge-0;if(Number.isNaN(u)||!Number.isFinite(u))throw new TypeError("option maxAge is invalid");i+="; Max-Age="+Math.floor(u)}if(r.domain){if(!w.test(r.domain))throw new TypeError("option domain is invalid");i+="; Domain="+r.domain}if(r.path){if(!w.test(r.path))throw new TypeError("option path is invalid");i+="; Path="+r.path}if(r.expires){if(!G(r.expires)||Number.isNaN(r.expires.valueOf()))throw new TypeError("option expires is invalid");i+="; Expires="+r.expires.toUTCString()}if(r.httpOnly&&(i+="; HttpOnly"),r.secure&&(i+="; Secure"),r.priority)switch(typeof r.priority=="string"?r.priority.toLowerCase():r.priority){case"low":{i+="; Priority=Low";break}case"medium":{i+="; Priority=Medium";break}case"high":{i+="; Priority=High";break}default:throw new TypeError("option priority is invalid")}if(r.sameSite)switch(typeof r.sameSite=="string"?r.sameSite.toLowerCase():r.sameSite){case!0:{i+="; SameSite=Strict";break}case"lax":{i+="; SameSite=Lax";break}case"strict":{i+="; SameSite=Strict";break}case"none":{i+="; SameSite=None";break}default:throw new TypeError("option sameSite is invalid")}return r.partitioned&&(i+="; Partitioned"),i}function G(t){return Object.prototype.toString.call(t)==="[object Date]"||t instanceof Date}function p(t){if(typeof t!="object")return t;var n,e,r=Object.prototype.toString.call(t);if(r==="[object Object]"){if(t.constructor!==Object&&typeof t.constructor=="function"){e=new t.constructor;for(n in t)t.hasOwnProperty(n)&&e[n]!==t[n]&&(e[n]=p(t[n]))}else{e={};for(n in t)n==="__proto__"?Object.defineProperty(e,n,{value:p(t[n]),configurable:!0,enumerable:!0,writable:!0}):e[n]=p(t[n])}return e}if(r==="[object Array]"){for(n=t.length,e=Array(n);n--;)e[n]=p(t[n]);return e}return r==="[object Set]"?(e=new Set,t.forEach(function(o){e.add(p(o))}),e):r==="[object Map]"?(e=new Map,t.forEach(function(o,s){e.set(p(s),p(o))}),e):r==="[object Date]"?new Date(+t):r==="[object RegExp]"?(e=new RegExp(t.source,t.flags),e.lastIndex=t.lastIndex,e):r==="[object DataView]"?new t.constructor(p(t.buffer)):r==="[object ArrayBuffer]"?t.slice(0):r.slice(-6)==="Array]"?new t.constructor(t):t}const K={path:"/",watch:!0,decode:t=>x(decodeURIComponent(t)),encode:t=>encodeURIComponent(typeof t=="string"?t:JSON.stringify(t))},m=globalThis.cookieStore;function S(t,n){const e={...K,...n};e.filter??=f=>f===t;const r=T(e)||{};let o;e.maxAge!==void 0?o=e.maxAge*1e3:e.expires&&(o=e.expires.getTime()-Date.now());const s=o!==void 0&&o<=0,i=s||r[t]===void 0||r[t]===null,u=p(s?void 0:r[t]??e.default?.()),l=o&&!s?Q(u,o,e.watch&&e.watch!=="shallow"):v(u);{let f=null;try{!m&&typeof BroadcastChannel<"u"&&(f=new BroadcastChannel(`nuxt:cookies:${t}`))}catch{}const h=(d=!1)=>{!d&&(e.readonly||_(l.value,r[t]))||(Y(t,l.value,e),r[t]=p(l.value),f?.postMessage({value:e.encode(l.value)}))},y=d=>{const g=d.refresh?T(e)?.[t]:e.decode(d.value);c=!0,l.value=g,r[t]=p(g),M(()=>{c=!1})};let c=!1;const a=!!z();if(a&&k(()=>{c=!0,h(),f?.close()}),m){const d=g=>{const A=g.changed.find(b=>b.name===t),I=g.deleted.find(b=>b.name===t);A&&y({value:A.value}),I&&y({value:null})};m.addEventListener("change",d),a&&k(()=>m.removeEventListener("change",d))}else f&&(f.onmessage=({data:d})=>y(d));e.watch&&C(l,()=>{c||h()},{deep:e.watch!=="shallow"}),i&&h(i)}return l}function T(t={}){return q(document.cookie,t)}function X(t,n,e={}){return n==null?j(t,n,{...e,maxAge:-1}):j(t,n,e)}function Y(t,n,e={}){document.cookie=X(t,n,e)}const O=2147483647;function Q(t,n,e){let r,o,s=0;const i=e?v(t):{value:t};return z()&&k(()=>{o?.(),clearTimeout(r)}),D((u,l)=>{e&&(o=C(i,l));function f(){s=0,clearTimeout(r);const h=n-s,y=h<O?h:O;r=setTimeout(()=>{if(s+=y,s<n)return f();i.value=void 0,l()},y)}return{get(){return u(),i.value},set(h){f(),i.value=h,l()}}})}const W=()=>{const t=V("auth-user",()=>null),n=L(()=>!!t.value),e=v(!1),r=v(null),o=async()=>{try{const c=S("auth-token");if(c.value){const a=await $fetch("/api/auth/verify",{method:"GET"}).catch(()=>null);a?.success&&a.data?t.value=a.data:c.value=null}}catch(c){console.error("初始化认证状态失败:",c);const a=S("auth-token");a.value=null}},s=async c=>{try{e.value=!0,r.value=null;const a=await $fetch("/api/auth/login",{method:"POST",body:c});if(a.success&&a.data)return t.value=a.data.user,a.data;throw new Error("登录失败")}catch(a){throw r.value=a.data?.statusMessage||a.message||"登录失败",a}finally{e.value=!1}},i=async c=>{try{e.value=!0,r.value=null;const a=await $fetch("/api/auth/register",{method:"POST",body:c});if(a.success&&a.data)return t.value=a.data.user,a.data;throw new Error("注册失败")}catch(a){throw r.value=a.data?.statusMessage||a.message||"注册失败",a}finally{e.value=!1}},u=async()=>{try{await $fetch("/api/auth/logout",{method:"POST"})}catch(c){console.error("退出登录请求失败:",c)}finally{t.value=null;const c=S("auth-token");c.value=null,await N("/login")}},l=async c=>{try{e.value=!0,r.value=null;const a=await $fetch("/api/user/profile",{method:"PUT",body:c});if(a.success&&a.data)return t.value=a.data,a.data;throw new Error("更新用户信息失败")}catch(a){throw r.value=a.data?.statusMessage||a.message||"更新用户信息失败",a}finally{e.value=!1}},f=async c=>{try{e.value=!0,r.value=null;const a=await $fetch("/api/user/preferences",{method:"PUT",body:{preferences:c}});if(a.success&&a.data)return t.value&&(t.value.preferences={...t.value.preferences,...c}),a.data;throw new Error("更新偏好设置失败")}catch(a){throw r.value=a.data?.statusMessage||a.message||"更新偏好设置失败",a}finally{e.value=!1}},h=async()=>{if(n.value)try{const c=await $fetch("/api/user/profile",{method:"GET"});c.success&&c.data&&(t.value=c.data)}catch(c){console.error("刷新用户信息失败:",c)}},y=c=>!!t.value;return{user:$(t),isAuthenticated:n,isLoading:$(e),error:$(r),initializeAuth:o,login:s,register:i,logout:u,updateProfile:l,updatePreferences:f,refreshUser:h,hasPermission:y}};export{W as u};
