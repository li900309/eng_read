# Eng Read åç«¯ Makefile
# ä½¿ç”¨ UV åŒ…ç®¡ç†å™¨

.PHONY: help install dev test lint format clean run db-upgrade db-migrate deploy optimize frozen-sync

# é»˜è®¤ç›®æ ‡
help:
	@echo "Eng Read åç«¯å¼€å‘å‘½ä»¤"
	@echo ""
	@echo "è®¾ç½®:"
	@echo "  install     å®‰è£…æ‰€æœ‰ä¾èµ–"
	@echo "  dev         å®‰è£…å¼€å‘ä¾èµ–"
	@echo "  clean       æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶"
	@echo ""
	@echo "å¼€å‘:"
	@echo "  run         å¯åŠ¨å¼€å‘æœåŠ¡å™¨"
	@echo "  test        è¿è¡Œæµ‹è¯•"
	@echo "  test-cov    è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š"
	@echo "  lint        ä»£ç æ£€æŸ¥"
	@echo "  format      ä»£ç æ ¼å¼åŒ–"
	@echo ""
	@echo "æ•°æ®åº“:"
	@echo "  db-init     åˆå§‹åŒ–æ•°æ®åº“"
	@echo "  db-migrate  åˆ›å»ºæ•°æ®åº“è¿ç§»"
	@echo "  db-upgrade  åº”ç”¨æ•°æ®åº“è¿ç§»"
	@echo "  db-seed     å¡«å……åˆå§‹æ•°æ®"
	@echo ""
	@echo "éƒ¨ç½²:"
	@echo "  build       æ„å»ºç”Ÿäº§ç¯å¢ƒ"
	@echo "  deploy      éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ"
	@echo ""
	@echo "UV å·¥å…·:"
	@echo "  optimize    ä¼˜åŒ–UVç¯å¢ƒå’Œç¼“å­˜"
	@echo "  frozen-sync åŒæ­¥å†»ç»“çš„ä¾èµ–"

# è®¾ç½®å‘½ä»¤
install:
	@if [ ! -d ".venv" ]; then uv venv; fi
	uv sync

dev:
	@if [ ! -d ".venv" ]; then uv venv; fi
	uv sync --all-extras

clean:
	@echo "æ¸…ç†ç¼“å­˜å’Œä¸´æ—¶æ–‡ä»¶..."
	uv cache clean
	rm -rf .coverage
	rm -rf htmlcov/
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	rm -rf build/
	rm -rf dist/
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete

# å¼€å‘å‘½ä»¤
run:
	uv run python run.py

test:
	uv run pytest

test-cov:
	uv run pytest --cov=app --cov-report=html --cov-report=term

lint:
	@echo "è¿è¡Œä»£ç æ£€æŸ¥..."
	uv run flake8 app/ tests/
	uv run mypy app/
	uv run bandit -r app/

format:
	@echo "æ ¼å¼åŒ–ä»£ç ..."
	uv run black app/ tests/
	uv run isort app/ tests/
	uv run autopep8 --in-place --recursive app/ tests/

check:
	@echo "è¿è¡Œæ‰€æœ‰æ£€æŸ¥..."
	$(MAKE) lint
	$(MAKE) test
	@echo "âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼"

# æ•°æ®åº“å‘½ä»¤
db-init:
	uv run flask db init

db-migrate:
	uv run flask db migrate -m "$(MSG)"

db-upgrade:
	uv run flask db upgrade

db-seed:
	uv run python scripts/seed_data.py

db-reset:
	uv run flask db downgrade base
	$(MAKE) db-upgrade
	$(MAKE) db-seed

# å¼€å‘å·¥ä½œæµ
dev-setup: install db-init db-upgrade
	@echo "ğŸš€ å¼€å‘ç¯å¢ƒè®¾ç½®å®Œæˆï¼"

dev-test: format lint test
	@echo "âœ… å¼€å‘æµ‹è¯•å®Œæˆï¼"

# ç”Ÿäº§å‘½ä»¤
build:
	@echo "æ„å»ºç”Ÿäº§ç¯å¢ƒ..."
	uv sync --only main
	uv run pip freeze > requirements.txt

deploy: build
	@echo "éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
	# è¿™é‡Œå¯ä»¥æ·»åŠ å…·ä½“çš„éƒ¨ç½²è„šæœ¬
	gunicorn -c gunicorn.conf.py run:app

# UV ä¼˜åŒ–å‘½ä»¤
optimize:
	@echo "ä¼˜åŒ–UVç¯å¢ƒ..."
	uv cache clean
	uv sync --clean

frozen-sync:
	@echo "åŒæ­¥å†»ç»“çš„ä¾èµ–..."
	uv sync --frozen

# æ•°æ®åº“è¿ç§»å·¥ä½œæµ
migrate:
	@read -p "è¾“å…¥è¿ç§»æè¿°: " msg; \
	uv run flask db migrate -m "$$msg"

migrate-up:
	$(MAKE) db-migrate MSG="Auto migration"
	$(MAKE) db-upgrade

# å®‰å…¨æ£€æŸ¥
security:
	@echo "è¿è¡Œå®‰å…¨æ£€æŸ¥..."
	uv run safety check
	uv run bandit -r app/

# æ€§èƒ½åˆ†æ
profile:
	uv run python -m cProfile -o profile.stats run.py

benchmark:
	uv run pytest --benchmark-only

# æ–‡æ¡£ç”Ÿæˆ
docs:
	uv run sphinx-build -b html docs/ docs/_build/

# æ—¥å¿—æŸ¥çœ‹
logs:
	tail -f logs/app.log

# ç¯å¢ƒä¿¡æ¯
info:
	@echo "=== ç¯å¢ƒä¿¡æ¯ ==="
	@echo "Python: $(shell uv python --version)"
	@echo "UV: $(shell uv --version)"
	@echo "è™šæ‹Ÿç¯å¢ƒ: $(shell uv venv --show-path)"
	@echo "å·²å®‰è£…åŒ…: $(shell uv pip list | wc -l) ä¸ª"

# é‡ç½®å¼€å‘ç¯å¢ƒ
reset-dev: clean install db-init db-upgrade db-seed
	@echo "ğŸ”„ å¼€å‘ç¯å¢ƒå·²é‡ç½®ï¼"

# å¿«é€Ÿå‘½ä»¤åˆ«å
s: run       # server
t: test      # test
f: format    # format
l: lint      # lint